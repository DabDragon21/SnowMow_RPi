<!DOCTYPE html>
<html>
<head>
    <title>Joystick Direction</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <meta charset="utf-8">
</head>
<body class="p-5">
    <h1>Joystick Direction</h1>
    <p>Direction: <span id="dir" class="fw-bold">loading...</span></p>
    <p>Status: <span id="sys" class="fw-bold">loading...</span></p>
    <p>Calibration mode: <span id="calibration-status" class = "fw-bold">OFF</span></p>
    <button id="toggle-calibration">Toggle Calibration</button>
    <h2>Calibration Totals</h2>
    <ul id="totals-list">
    <!-- Filled dynamically -->
    </ul>
    <p>Net forward distance: <span id='net-forward'>loading...</span> feet</p>
    <p>Position: <span id = 'pos'></span></p>
    <p>Max Distance: <span id="max-distance">0</span> feet</p>
    <p>Max Position: <span id = "max-pos">(0, 0)</span></p>
    <script>
        document.getElementById("toggle-calibration").addEventListener("click", async () => {
            const res = await fetch("/toggle_calibration", { method: "POST" });
            const data = await res.json();
            document.getElementById("calibration-status").textContent =
                data.calibration_mode ? "ON" : "OFF";
        });
            // Fetch totals every 1 second and update the list
        async function updateTotals() {
            const res = await fetch('/totals');
            const totals = await res.json();
            const ul = document.getElementById('totals-list');
            ul.innerHTML = '';  // clear current list

            for (const [direction, seconds] of Object.entries(totals)) {
            const li = document.createElement('li');
            li.textContent = `${direction}: ${seconds.toFixed(2)} seconds`;
            ul.appendChild(li);
            }
        }

        async function updateDimensions(){
            const res = await fetch('/dimensions');
            const totals = await res.json();
            document.getElementById('net-forward').textContent = totals.net_forward.toFixed(2);
        }
        function fetchPosition() {
            fetch('/position')
                .then(response => response.json())  // get raw string
                .then(data => {
                    const x = data.x.toFixed(2); // round to 2 decimals
                    const y = data.y.toFixed(2);
                    document.getElementById("pos").textContent = `(${x}, ${y})`;
                })
                .catch(error => {
                    console.error('Error fetching position:', error);
                });
        }
        function updateMaxDistance() {
            fetch('/max_distance')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('max-distance').textContent = data.max_distance;
                     // Make sure corner exists and has 2 elements
                    if (data.corner && data.corner.length === 2) {
                        const x = parseFloat(data.corner[0]).toFixed(2);
                        const y = parseFloat(data.corner[1]).toFixed(2);
                        document.getElementById('max-pos').textContent = `(${x}, ${y})`;
            }
                    
                })
                .catch(err => console.error('Error fetching max distance:', err));
        }

        // Call every 1 second
        setInterval(updateMaxDistance, 1000);


        // Fetch every second
        setInterval(fetchPosition, 1000);
        setInterval(updateDimensions, 1000);
        updateDimensions();
        setInterval(updateTotals, 1000);
        updateTotals();  // initial call on page load
        function updateDirection() {
            fetch('/direction')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('dir').textContent = data.direction;
                    document.getElementById('sys').textContent = data.system;
                });
        }

        setInterval(updateDirection, 200);
    </script>


    </script>
</body>
</html>
